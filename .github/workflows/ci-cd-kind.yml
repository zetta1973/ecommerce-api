name: CI/CD Pipeline with Kind

on:
  push:
    branches:
      - main
      - develop
      - 'feature/**'
  pull_request:
    branches:
      - main
      - develop

jobs:
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'

      - name: Run tests
        run: mvn test

      - name: Generate test coverage report
        run: mvn jacoco:report

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: target/site/jacoco/

  build-and-deploy-app:
    name: Build and Deploy Application to Kind
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.event_name == 'push'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'

      - name: Build JAR
        run: mvn clean package -DskipTests

      - name: Verify JAR exists
        run: ls -la target/*.jar

      - name: Create Kind cluster and test locally
        run: |
          # Install Kind
          curl -Lo ./kind https://kind.sigs.k8s.io/dl/v0.23.0/kind-linux-amd64
          chmod +x ./kind
          sudo mv ./kind /usr/local/bin/kind

          # Create simple cluster
          kind create cluster --name ecommerce --wait 60s

          # Test application locally first
          echo "Testing application startup locally..."
          timeout 30 java -jar target/*.jar --spring.profiles.active=ci &
          APP_PID=$!
          sleep 10

          # Check if process is still running
          if kill -0 $APP_PID 2>/dev/null; then
            echo "✅ Application started successfully locally"
            kill $APP_PID
          else
            echo "❌ Application failed to start locally"
            exit 1
          fi

          # Build and load image
          docker build -t ecommerce-api:ci .
          kind load docker-image ecommerce-api:ci --name ecommerce

          # Update deployment
          sed -i 's|ghcr.io/zetta1973/ecommerce-api:latest|ecommerce-api:ci|g' k8s/application/deployment.yaml

          # Deploy
          kubectl apply -f k8s/application/

           # Wait with diagnostics
           echo "Waiting for pod to be ready..."
           kubectl get pods -l app=ecommerce-api
           if ! kubectl wait --for=condition=ready pod -l app=ecommerce-api --timeout=60s; then
             echo "❌ Pod failed to become ready. Gathering diagnostic information..."

             kubectl get pods -l app=ecommerce-api -o wide
             kubectl describe pod -l app=ecommerce-api
             kubectl get events --sort-by=.metadata.creationTimestamp
             echo "Pod logs:"
             kubectl logs -l app=ecommerce-api --tail=100 || echo "No logs available"
             echo "Container logs:"
             kubectl logs -l app=ecommerce-api -c ecommerce-api --tail=100 || echo "No container logs"

             exit 1
           fi

          echo "✅ Pod is ready!"

      - name: Test application
        run: |
          # Port forward and test
          kubectl port-forward svc/ecommerce-api 8080:8080 &
          PF_PID=$!

          # Wait for port forward to be ready
          sleep 10

          # Test health endpoint
          if curl -f http://localhost:8080/actuator/health; then
            echo "✅ Application is healthy!"
          else
            echo "❌ Application health check failed"
            kubectl logs -l app=ecommerce-api
            exit 1
          fi

          # Test API endpoint
          if curl -f http://localhost:8080/products; then
            echo "✅ API is responding!"
          else
            echo "❌ API endpoint failed"
            exit 1
          fi

          kill $PF_PID