package com.ecommerce.integration;

import com.ecommerce.controller.AdminController;
import com.ecommerce.model.Role;
import com.ecommerce.model.User;
import com.ecommerce.repository.UserRepository;
import com.ecommerce.security.JwtUtil;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Disabled;
import org.junit.jupiter.api.Test;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.data.domain.Example;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.data.domain.Sort;
import org.springframework.data.repository.query.FluentQuery.FetchableFluentQuery;
import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.test.web.servlet.MockMvc;
import org.springframework.test.web.servlet.setup.MockMvcBuilders;

import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.Optional;
import java.util.function.Function;

import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.get;
import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.status;

class AdminAccessTest {

    private MockMvc mockMvc;
    private UserRepository userRepo;
    private PasswordEncoder encoder;

    @BeforeEach
    void setup() {
        this.encoder = new BCryptPasswordEncoder();
        this.userRepo = new InMemoryUserRepo();


        User admin = new User();
        admin.setUsername("admin");
        admin.setEmail("admin@example.com");
        admin.setPassword(encoder.encode("adminpass"));
        Role adminRole = new Role();
        adminRole.setName("ADMIN");
        admin.setRole(adminRole);
        userRepo.save(admin);

        User user = new User();
        user.setUsername("user");
        user.setEmail("user@example.com");
        user.setPassword(encoder.encode("userpass"));
        Role userRole = new Role();
        userRole.setName("USER");
        user.setRole(userRole);
        userRepo.save(user);

        // Inicializar MockMvc con controlador real
        this.mockMvc = MockMvcBuilders.standaloneSetup(new AdminController(userRepo))
                .build();
    }

    @Test
    void shouldAllowAdminAccess() throws Exception {
        Optional<User> admin = userRepo.findByEmail("admin@example.com");
        String token = JwtUtil.generateToken(admin.get());

        mockMvc.perform(get("/admin/ping")
                .header("Authorization", "Bearer " + token))
                .andExpect(status().isOk());
    }

    @Test
    void shouldRejectUserAccess() throws Exception {
        Optional<User> user = userRepo.findByEmail("user@example.com");
        String token = JwtUtil.generateToken(user.get());

        mockMvc.perform(get("/admin/ping")
                .header("Authorization", "Bearer " + token))
                .andExpect(status().isOk());
    }

    // Repositorio en memoria simplificado
    static class InMemoryUserRepo implements UserRepository{
        private Map<String, User> users = new HashMap<>();

        @Override
        public <S extends User> S save(S entity) {
            users.put(entity.getEmail(), entity);
            return entity;
        }

        @Override
        public Optional<User> findByEmail(String email) {
            return Optional.ofNullable(users.get(email));
        }

        @Override
        public void flush() {
            // TODO Auto-generated method stub
            throw new UnsupportedOperationException("Unimplemented method 'flush'");
        }

        @Override
        public <S extends User> S saveAndFlush(S entity) {
            // TODO Auto-generated method stub
            throw new UnsupportedOperationException("Unimplemented method 'saveAndFlush'");
        }

        @Override
        public <S extends User> List<S> saveAllAndFlush(Iterable<S> entities) {
            // TODO Auto-generated method stub
            throw new UnsupportedOperationException("Unimplemented method 'saveAllAndFlush'");
        }

        @Override
        public void deleteAllInBatch(Iterable<User> entities) {
            // TODO Auto-generated method stub
            throw new UnsupportedOperationException("Unimplemented method 'deleteAllInBatch'");
        }

        @Override
        public void deleteAllByIdInBatch(Iterable<Long> ids) {
            // TODO Auto-generated method stub
            throw new UnsupportedOperationException("Unimplemented method 'deleteAllByIdInBatch'");
        }

        @Override
        public void deleteAllInBatch() {
            // TODO Auto-generated method stub
            throw new UnsupportedOperationException("Unimplemented method 'deleteAllInBatch'");
        }

        @Override
        public User getOne(Long id) {
            // TODO Auto-generated method stub
            throw new UnsupportedOperationException("Unimplemented method 'getOne'");
        }

        @Override
        public User getById(Long id) {
            // TODO Auto-generated method stub
            throw new UnsupportedOperationException("Unimplemented method 'getById'");
        }

        @Override
        public User getReferenceById(Long id) {
            // TODO Auto-generated method stub
            throw new UnsupportedOperationException("Unimplemented method 'getReferenceById'");
        }

        @Override
        public <S extends User> List<S> findAll(Example<S> example) {
            // TODO Auto-generated method stub
            throw new UnsupportedOperationException("Unimplemented method 'findAll'");
        }

        @Override
        public <S extends User> List<S> findAll(Example<S> example, Sort sort) {
            // TODO Auto-generated method stub
            throw new UnsupportedOperationException("Unimplemented method 'findAll'");
        }

        @Override
        public <S extends User> List<S> saveAll(Iterable<S> entities) {
            // TODO Auto-generated method stub
            throw new UnsupportedOperationException("Unimplemented method 'saveAll'");
        }

        @Override
        public List<User> findAll() {
            // TODO Auto-generated method stub
            throw new UnsupportedOperationException("Unimplemented method 'findAll'");
        }

        @Override
        public List<User> findAllById(Iterable<Long> ids) {
            // TODO Auto-generated method stub
            throw new UnsupportedOperationException("Unimplemented method 'findAllById'");
        }

        @Override
        public Optional<User> findById(Long id) {
            // TODO Auto-generated method stub
            throw new UnsupportedOperationException("Unimplemented method 'findById'");
        }

        @Override
        public boolean existsById(Long id) {
            // TODO Auto-generated method stub
            throw new UnsupportedOperationException("Unimplemented method 'existsById'");
        }

        @Override
        public long count() {
            // TODO Auto-generated method stub
            throw new UnsupportedOperationException("Unimplemented method 'count'");
        }

        @Override
        public void deleteById(Long id) {
            // TODO Auto-generated method stub
            throw new UnsupportedOperationException("Unimplemented method 'deleteById'");
        }

        @Override
        public void delete(User entity) {
            // TODO Auto-generated method stub
            throw new UnsupportedOperationException("Unimplemented method 'delete'");
        }

        @Override
        public void deleteAllById(Iterable<? extends Long> ids) {
            // TODO Auto-generated method stub
            throw new UnsupportedOperationException("Unimplemented method 'deleteAllById'");
        }

        @Override
        public void deleteAll(Iterable<? extends User> entities) {
            // TODO Auto-generated method stub
            throw new UnsupportedOperationException("Unimplemented method 'deleteAll'");
        }

        @Override
        public void deleteAll() {
            // TODO Auto-generated method stub
            throw new UnsupportedOperationException("Unimplemented method 'deleteAll'");
        }

        @Override
        public List<User> findAll(Sort sort) {
            // TODO Auto-generated method stub
            throw new UnsupportedOperationException("Unimplemented method 'findAll'");
        }

        @Override
        public Page<User> findAll(Pageable pageable) {
            // TODO Auto-generated method stub
            throw new UnsupportedOperationException("Unimplemented method 'findAll'");
        }

        @Override
        public <S extends User> Optional<S> findOne(Example<S> example) {
            // TODO Auto-generated method stub
            throw new UnsupportedOperationException("Unimplemented method 'findOne'");
        }

        @Override
        public <S extends User> Page<S> findAll(Example<S> example, Pageable pageable) {
            // TODO Auto-generated method stub
            throw new UnsupportedOperationException("Unimplemented method 'findAll'");
        }

        @Override
        public <S extends User> long count(Example<S> example) {
            // TODO Auto-generated method stub
            throw new UnsupportedOperationException("Unimplemented method 'count'");
        }

        @Override
        public <S extends User> boolean exists(Example<S> example) {
            // TODO Auto-generated method stub
            throw new UnsupportedOperationException("Unimplemented method 'exists'");
        }

        @Override
        public <S extends User, R> R findBy(Example<S> example, Function<FetchableFluentQuery<S>, R> queryFunction) {
            // TODO Auto-generated method stub
            throw new UnsupportedOperationException("Unimplemented method 'findBy'");
        }

        // MÃ©todos no implementados omitidos por brevedad
    }
}
