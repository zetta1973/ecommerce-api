name: CI/CD Pipeline with Kind

on:
  push:
    branches:
      - main
      - develop
      - 'feature/**'
  pull_request:
    branches:
      - main
      - develop

jobs:
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'

      - name: Run tests
        run: mvn test

      - name: Generate test coverage report
        run: mvn jacoco:report

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: target/site/jacoco/

  build-and-deploy-app:
    name: Build and Deploy Application to Kind
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.event_name == 'push'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'

      - name: Build JAR
        run: mvn package -DskipTests

      - name: Build and load Docker image into Kind
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: |
            image=moby/buildkit:master
            network=host

      - name: Create Kind cluster and deploy
        run: |
          # Install Kind
          curl -Lo ./kind https://kind.sigs.k8s.io/dl/v0.23.0/kind-linux-amd64
          chmod +x ./kind
          sudo mv ./kind /usr/local/bin/kind

          # Create cluster
          kind create cluster --name ecommerce --config - <<EOF
          kind: Cluster
          apiVersion: kind.x-k8s.io/v1alpha4
          nodes:
          - role: control-plane
            kubeadmConfigPatches:
            - |
              kind: InitConfiguration
              nodeRegistration:
                kubeletExtraArgs:
                  node-labels: "ingress-ready=true"
            extraPortMappings:
            - containerPort: 80
              hostPort: 80
              protocol: TCP
            - containerPort: 443
              hostPort: 443
              protocol: TCP
          EOF

          # Build and load image
          docker build -t ecommerce-api:ci .
          kind load docker-image ecommerce-api:ci --name ecommerce

          # Update deployment image reference
          sed -i 's|ghcr.io/zetta1973/ecommerce-api:latest|ecommerce-api:ci|g' k8s/application/deployment.yaml

          # Deploy application
          kubectl apply -f k8s/application/
          kubectl wait --for=condition=ready pod -l app=ecommerce-api --timeout=300s

      - name: Test application
        run: |
          # Port forward and test
          kubectl port-forward svc/ecommerce-api 8080:8080 &
          PF_PID=$!

          # Wait for port forward to be ready
          sleep 10

          # Test health endpoint
          if curl -f http://localhost:8080/actuator/health; then
            echo "✅ Application is healthy!"
          else
            echo "❌ Application health check failed"
            kubectl logs -l app=ecommerce-api
            exit 1
          fi

          # Test API endpoint
          if curl -f http://localhost:8080/products; then
            echo "✅ API is responding!"
          else
            echo "❌ API endpoint failed"
            exit 1
          fi

          kill $PF_PID